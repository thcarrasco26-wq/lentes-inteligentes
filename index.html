<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Simulador Lentes Inteligentes ‚Äî Visor</title>
<style>
  :root{
    --bg:#0f1724;
    --panel:#0b1220cc;
    --accent:#06b6d4;
    --glass:#00b894;
    --hud: rgba(0,0,0,0.35);
  }
  html,body{height:100%;margin:0;font-family:Inter,Arial,Helvetica,sans-serif;background:linear-gradient(180deg,#071029 0%, #0f1724 100%);color:#e6eef6}
  .wrap{max-width:1100px;margin:24px auto;padding:18px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));box-shadow:0 8px 30px rgba(2,6,23,0.6)}
  header{display:flex;align-items:center;justify-content:space-between}
  header h1{font-size:20px;margin:0}
  #visor{position:relative;margin-top:12px;border-radius:12px;overflow:hidden;background:#000;display:flex;align-items:center;justify-content:center;height:620px}
  canvas#mainCanvas{width:100%;height:100%;display:block}
  .controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
  .btn{background:var(--panel);border:1px solid rgba(255,255,255,0.04);color:#e8f6ff;padding:8px 12px;border-radius:8px;cursor:pointer}
  .btn.primary{background:linear-gradient(90deg,var(--glass),#00a97a);color:#022; font-weight:600}
  .hud-box,.right-hud{position:absolute;padding:10px 12px;border-radius:8px;background:var(--hud);backdrop-filter:blur(4px);color:#fff}
  .hud-box{left:16px;top:16px}
  .right-hud{right:16px;top:16px;text-align:right}
  .label{font-size:12px;opacity:0.9}
  .small{font-size:13px;opacity:0.85}
  .switch{position:relative;width:46px;height:26px;background:#111;border-radius:16px;padding:3px;cursor:pointer}
  .knob{position:absolute;left:3px;top:3px;width:20px;height:20px;border-radius:50%;background:#fff;transition:all .18s}
  .switch.on{background:linear-gradient(90deg,var(--accent),#0ea5a6);}
  .switch.on .knob{transform:translateX(20px)}
  .detector{position:absolute;pointer-events:none;}
  .detector .box{position:absolute;border:2px solid rgba(0,255,200,0.9);border-radius:6px;box-shadow:0 6px 20px rgba(0,255,200,0.06);background:linear-gradient(180deg,rgba(0,255,200,0.04),rgba(0,0,0,0.06));}
  .label-tag{position:absolute;padding:6px;border-radius:6px;background:rgba(0,0,0,0.6);color:#bff;font-size:13px;border:1px solid rgba(0,255,200,0.2)}
  .vignette{position:absolute;inset:0;pointer-events:none;background:radial-gradient(60% 60% at 50% 40%,rgba(0,0,0,0) 0%,rgba(0,0,0,0) 50%,rgba(0,0,0,0.35) 100%);}
  .frame-glow{position:absolute;inset:0;border-radius:12px;box-shadow:0 0 90px rgba(0,200,160,0.06) inset;pointer-events:none}
  .caption{position:absolute;left:50%;transform:translateX(-50%);bottom:14px;background:rgba(2,6,23,0.5);padding:8px 12px;border-radius:999px;font-size:13px}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Simulador ‚Äî Lentes Inteligentes (Visor Urbano)</h1>
        <div class="small" id="modeChip">Modo: SIN lentes</div>
      </div>
      <div style="text-align:right">
        <div class="label">Proyecto: Lentes inteligentes ‚Äî TIF</div>
        <div class="small">Simulaci√≥n interactiva</div>
      </div>
    </header>

    <div id="visor">
      <canvas id="mainCanvas"></canvas>
      <div class="hud-box" id="leftHud"><div id="timeNow">--:--</div><div class="label">Visor AI</div></div>
      <div class="right-hud" id="rightHud"><div id="temp">Temp: 22¬∞C</div><div id="battery">Bater√≠a: 86%</div></div>
      <div class="vignette"></div><div class="frame-glow"></div>
      <div class="caption" id="captionText">Pulsa ‚ÄúActivar lentes‚Äù para mejorar visi√≥n</div>
      <div id="detectorOverlay" class="detector"></div>
    </div>

    <div class="controls">
      <button class="btn primary" id="toggleLensBtn">Activar lentes</button>
      <button class="btn" id="toggleDetectBtn">Mostrar detecci√≥n</button>
      <button class="btn" id="autoRotateBtn">Auto-rotar: ON</button>
      <button class="btn" id="prevBtn">‚óÄ Anterior</button>
      <button class="btn" id="nextBtn">Siguiente ‚ñ∂</button>
      <button class="btn" id="captureBtn">üì∑ Captura</button>
    </div>

    <footer class="small" style="margin-top:10px;opacity:0.8">Sube tus im√°genes urbanas al repositorio y n√≥mbralas <code>image1.jpg</code>, <code>image2.jpg</code>, etc.</footer>
  </div>

<script>
/* CONFIGURACI√ìN */
const IMAGES = ['image1.jpg','image2.jpg','image3.jpg','image4.jpg'];
const ROTATE_INTERVAL = 7000;

/* VARIABLES */
const canvas=document.getElementById('mainCanvas');
const ctx=canvas.getContext('2d');
const overlay=document.getElementById('detectorOverlay');
const caption=document.getElementById('captionText');
const modeChip=document.getElementById('modeChip');
let canvasWidth=1000,canvasHeight=600,currentIndex=0,images=[],lensOn=false,detectOn=false,hudOn=true,autoRotate=true,rotateTimer=null;

/* ---------- DETECCI√ìN AUTOM√ÅTICA PRECISA ---------- */
const EDGE_THRESHOLD=55,MIN_COMPONENT_PIXELS=300,MERGE_DISTANCE=25,MAX_DETECTIONS=10;
function getImagePixelsScaled(img){const tmp=document.createElement('canvas');tmp.width=canvas.width;tmp.height=canvas.height;const tctx=tmp.getContext('2d');const iw=img.width,ih=img.height;const cw=canvas.width,ch=canvas.height;const ir=iw/ih,cr=cw/ch;let dw,dh;if(ir>cr){dh=ch;dw=dh*ir;}else{dw=cw;dh=dw/ir;}const dx=(cw-dw)/2,dy=(ch-dh)/2;tctx.drawImage(img,0,0,iw,ih,dx,dy,dw,dh);return tctx.getImageData(0,0,tmp.width,tmp.height);}
function grayscaleFromImageData(i){const w=i.width,h=i.height,g=new Uint8ClampedArray(w*h),d=i.data;let x=0;for(let i2=0;i2<d.length;i2+=4){g[x++]=0.2126*d[i2]+0.7152*d[i2+1]+0.0722*d[i2+2];}return{gray:g,w,h};}
function sobel(o){const{gray,w,h}=o,g2=new Uint8ClampedArray(w*h);for(let y=1;y<h-1;y++){for(let x=1;x<w-1;x++){const i=y*w+x,gx=-gray[i-w-1]-2*gray[i-1]-gray[i+w-1]+gray[i-w+1]+2*gray[i+1]+gray[i+w+1],gy=-gray[i-w-1]-2*gray[i-w]-gray[i-w+1]+gray[i+w-1]+2*gray[i+w]+gray[i+w+1],gval=Math.hypot(gx,gy);g2[i]=gval>255?255:gval;}}return{grad:g2,w,h};}
function findComponents(o,t,m){const{grad,w,h}=o,v=new Uint8Array(w*h),c=[],s=[];for(let y=0;y<h;y++){for(let x=0;x<w;x++){const i=y*w+x;if(v[i]||grad[i]<t)continue;let minX=x,maxX=x,minY=y,maxY=y,count=0;s.push(i);v[i]=1;while(s.length){const cur=s.pop(),cy=Math.floor(cur/w),cx=cur%w;count++;if(cx<minX)minX=cx;if(cx>maxX)maxX=cx;if(cy<minY)minY=cy;if(cy>maxY)maxY=cy;for(let ny=cy-1;ny<=cy+1;ny++){if(ny<0||ny>=h)continue;for(let nx=cx-1;nx<=cx+1;nx++){if(nx<0||nx>=w)continue;const ni=ny*w+nx;if(!v[ni]&&grad[ni]>=t){v[ni]=1;s.push(ni);}else v[ni]=1;}}}if(count>=m)c.push({minX,minY,maxX,maxY,count});}}return c;}
function mergeBoxes(b,d){const m=[],u=new Array(b.length).fill(false);for(let i=0;i<b.length;i++){if(u[i])continue;let a=b[i];for(let j=i+1;j<b.length;j++){if(u[j])continue;const e=b[j],ax=(a.minX+a.maxX)/2,ay=(a.minY+a.maxY)/2,bx=(e.minX+e.maxX)/2,by=(e.minY+e.maxY)/2;if(Math.hypot(ax-bx,ay-by)<d){a={minX:Math.min(a.minX,e.minX),minY:Math.min(a.minY,e.minY),maxX:Math.max(a.maxX,e.maxX),maxY:Math.max(a.maxY,e.maxY),count:a.count+e.count};u[j]=true;}}m.push(a);u[i]=true;}return m;}
function componentsToDetections(c,w,h){return c.map(x=>{const a=(x.maxX-x.minX)/(x.maxY-x.minY+1e-6);let l='Objeto';if(a>1.6&&x.count>900)l='Auto';else if(a<0.8&&x.count<2500)l='Persona';else if(x.count>3500)l='Estructura';return{x:x.minX/w,y:x.minY/h,w:(x.maxX-x.minX)/w,h:(x.maxY-x.minY)/h,label:l};});}
function getDetectionsForCurrent(){const img=images[currentIndex];if(!img||!img.complete)return[];try{const d=getImagePixelsScaled(img),g=grayscaleFromImageData(d),s=sobel(g),c=findComponents(s,EDGE_THRESHOLD,MIN_COMPONENT_PIXELS);let b=mergeBoxes(c,MERGE_DISTANCE*devicePixelRatio);b.sort((a,b2)=>b2.count-a.count);b=b.slice(0,MAX_DETECTIONS);return componentsToDetections(b,s.w,s.h);}catch(e){console.warn('Error detecci√≥n:',e);return[];}}
function drawDetectionsCanvas(){const dets=getDetectionsForCurrent();dets.forEach(d=>{const x=d.x*canvasWidth,y=d.y*canvasHeight,w=d.w*canvasWidth,h=d.h*canvasHeight;ctx.save();ctx.lineWidth=2.5*devicePixelRatio;ctx.strokeStyle='rgba(0,255,200,0.85)';ctx.fillStyle='rgba(0,255,200,0.03)';roundRect(ctx,x,y,w,h,6*devicePixelRatio);ctx.fill();ctx.stroke();ctx.fillStyle='rgba(0,0,0,0.5)';ctx.fillRect(x,y-22*devicePixelRatio,ctx.measureText(d.label).width+14*devicePixelRatio,20*devicePixelRatio);ctx.fillStyle='#aff';ctx.font=`${13*devicePixelRatio}px sans-serif`;ctx.fillText(d.label,x+7*devicePixelRatio,y-8*devicePixelRatio);ctx.restore();});}
function drawDetectionsDOM(){clearDetectionsDOM();const dets=getDetectionsForCurrent(),r=overlay.getBoundingClientRect();dets.forEach(d=>{const b=document.createElement('div');b.className='box';b.style.left=(d.x*r.width)+'px';b.style.top=(d.y*r.height)+'px';b.style.width=(d.w*r.width)+'px';b.style.height=(d.h*r.height)+'px';overlay.appendChild(b);const t=document.createElement('div');t.className='label-tag';t.textContent=d.label;t.style.left=(d.x*r.width)+'px';t.style.top=(d.y*r.height-25)+'px';overlay.appendChild(t);});}
function clearDetectionsDOM(){while(overlay.firstChild)overlay.removeChild(overlay.firstChild);}
function roundRect(ctx,x,y,w,h,r){ctx.beginPath();ctx.moveTo(x+r,y);ctx.arcTo(x+w,y,x+w,y+h,r);ctx.arcTo(x+w,y+h,x,y+h,r);ctx.arcTo(x,y+h,x,y,r);ctx.arcTo(x,y,x+w,y,r);ctx.closePath();}

/* RENDER */
function render(){
  ctx.clearRect(0,0,canvasWidth,canvasHeight);
  const img=images[currentIndex];
  if(!img||!img.complete){ctx.fillStyle='#111';ctx.fillRect(0,0,canvasWidth,canvasHeight);caption.textContent='Cargando imagen...';return;}
  const iw=img.width,ih=img.height,cw=canvasWidth,ch=canvasHeight,ir=iw/ih,cr=cw/ch;let dw,dh;
  if(ir>cr){dh=ch;dw=dh*ir;}else{dw=cw;dh=dw/ir;}
  const dx=(cw-dw)/2,dy=(ch-dh)/2;
  if(!lensOn){
    const tmp=document.createElement('canvas');tmp.width=Math.max(200,Math.round(dw*0.3));tmp.height=Math.max(120,Math.round(dh*0.3));
    const tctx=tmp.getContext('2d');tctx.drawImage(img,0,0,iw,ih,0,0,tmp.width,tmp.height);
    ctx.imageSmoothingEnabled=true;ctx.imageSmoothingQuality='low';ctx.globalAlpha=0.95;
    ctx.drawImage(tmp,0,0,tmp.width,tmp.height,dx,dy,dw,dh);ctx.globalAlpha=1;ctx.fillStyle='rgba(0,0,0,0.22)';ctx.fillRect(0,0,canvasWidth,canvasHeight);
    caption.textContent='Modo: SIN lentes ‚Äî visi√≥n degradada';modeChip.textContent='Modo: SIN lentes';
  } else {
    ctx.imageSmoothingEnabled=true;ctx.imageSmoothingQuality='high';
    ctx.drawImage(img,0,0,iw,ih,dx,dy,dw,dh);
    ctx.globalAlpha=0.8;ctx.globalCompositeOperation='lighter';
    ctx.drawImage(img,0,0,iw,ih,dx-1*devicePixelRatio,dy-1*devicePixelRatio,dw+2*devicePixelRatio,dh+2*devicePixelRatio);
    ctx.globalAlpha=1;ctx.globalCompositeOperation='source-over';
    caption.textContent='Modo: CON lentes ‚Äî mejora activada';modeChip.textContent='Modo: CON lentes';
  }
  if(hudOn){ctx.fillStyle='rgba(0,0,0,0.28)';roundRect(ctx,16,16,240,60,8);ctx.fill();ctx.fillStyle='#dff';ctx.font='14px sans-serif';ctx.fillText(getTimeString(),28,36);ctx.font='12px sans-serif';ctx.fillStyle='#bfe';ctx.fillText('Visor AI ¬∑ Demo',28,54);}
  if(detectOn){drawDetectionsCanvas();drawDetectionsDOM();}else clearDetectionsDOM();
}

/* CONTROLES */
document.getElementById('toggleLensBtn').onclick=()=>{lensOn=!lensOn;document.getElementById('toggleLensBtn').textContent=lensOn?'Desactivar lentes':'Activar lentes';render();};
document.getElementById('toggleDetectBtn').onclick=()=>{detectOn=!detectOn;document.getElementById('toggleDetectBtn').textContent=detectOn?'Ocultar detecci√≥n':'Mostrar detecci√≥n';render();};
document.getElementById('prevBtn').onclick=()=>{currentIndex=(currentIndex-1+IMAGES.length)%IMAGES.length;render();};
document.getElementById('nextBtn').onclick=()=>{currentIndex=(currentIndex+1)%IMAGES.length;render();};
document.getElementById('autoRotateBtn').onclick=()=>{autoRotate=!autoRotate;document.getElementById('autoRotateBtn').textContent='Auto-rotar: '+(autoRotate?'ON':'OFF');if(autoRotate)startRotate();else stopRotate();};
document.getElementById('captureBtn').onclick=()=>{const link=document.createElement('a');link.download='captura_lentes.png';link.href=canvas.toDataURL();link.click();};

/* FUNCIONES EXTRA */
function getTimeString(){const d=new Date();return d.toLocaleTimeString('es-PE',{hour:'2-digit',minute:'2-digit'});}
function startRotate(){stopRotate();rotateTimer=setInterval(()=>{if(autoRotate){currentIndex=(currentIndex+1)%IMAGES.length;render();}},ROTATE_INTERVAL);}
function stopRotate(){if(rotateTimer)clearInterval(rotateTimer);}

/* INICIALIZAR */
function init(){
  canvasWidth=canvas.clientWidth*devicePixelRatio;
  canvasHeight=canvas.clientHeight*devicePixelRatio;
  canvas.width=canvasWidth;canvas.height=canvasHeight;
  IMAGES.forEach(src=>{const img=new Image();img.src=src;images.push(img);});
  startRotate();render();
}
window.addEventListener('resize',()=>{init();});
init();
</script>
</body>
</html>
